name: Deploy to production

on:
  push:
    branches:
      - production

env:
  RELEASE_BASE: ${{ secrets.DEPLOY_PATH }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start ssh-agent and add private key
        env:
          SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          eval "$(ssh-agent -s)"
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-add ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Create release dir on remote
        id: release
        run: |
          TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "release_dir=${{ secrets.DEPLOY_PATH }}/releases/$TIMESTAMP" >> $GITHUB_OUTPUT
        shell: bash

      - name: RSYNC project to remote release dir
        run: |
          RELEASE_DIR="${{ steps.release.outputs.release_dir }}"
          echo "Will rsync to $RELEASE_DIR"

          ssh -o StrictHostKeyChecking=no -p ${REMOTE_PORT:-22} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "mkdir -p $RELEASE_DIR"

          rsync -avz --delete \
            --exclude node_modules \
            --exclude '**/node_modules' \
            --exclude .git \
            --exclude .github \
            --exclude /var/www/clinicode.ru \
            ./ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:$RELEASE_DIR/
        env:
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}

      - name: Run remote deploy script
        run: |
          RELEASE_DIR="${{ steps.release.outputs.release_dir }}"
          ssh -o StrictHostKeyChecking=no -p ${REMOTE_PORT:-22} \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "bash ${{ secrets.DEPLOY_PATH }}/shared/deploy.sh $RELEASE_DIR"
        env:
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
